
<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pixel Beacon (Single File)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>body{background:#f8f9fa} .box{max-width:860px;margin:40px auto}</style>
</head><body>
<div class="box card shadow-sm">
  <div class="card-body">
    <h4 class="mb-3">Pixel Beacon (Single File)</h4>
    <p class="text-muted small">Sends real browser beacons to <code>https://www.facebook.com/tr</code>. Disable ad blockers for this site or use Incognito.</p>
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label small">Pixel ID</label>
        <input id="pb-pixel" class="form-control" placeholder="e.g. 123456789012345">
      </div>
      <div class="col-md-4">
        <label class="form-label small">Event</label>
        <select id="pb-event" class="form-select">
          <option>PageView</option>
          <option>ViewContent</option>
          <option>AddToCart</option>
          <option>InitiateCheckout</option>
          <option>Purchase</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label small">QPS (1‑10)</label>
        <input id="pb-qps" type="number" min="1" max="10" class="form-control" value="3">
      </div>
      <div class="col-md-4">
        <label class="form-label small">Duration (sec)</label>
        <input id="pb-dur" type="number" min="1" class="form-control" value="60">
      </div>
      <div class="col-md-4">
        <label class="form-label small">Value (Purchase)</label>
        <input id="pb-val" type="number" step="0.01" class="form-control" value="19.99">
      </div>
      <div class="col-md-4">
        <label class="form-label small">Currency</label>
        <input id="pb-cur" class="form-control" value="USD">
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label small me-2">Event ID</label>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="pb-eid-mode" id="pb-eid-auto" value="auto" checked>
        <label class="form-check-label" for="pb-eid-auto">auto (none)</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="pb-eid-mode" id="pb-eid-uuid" value="uuid">
        <label class="form-check-label" for="pb-eid-uuid">uuid</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="pb-eid-mode" id="pb-eid-fixed" value="fixed">
        <label class="form-check-label" for="pb-eid-fixed">fixed</label>
      </div>
      <input id="pb-eid-fixed-val" class="form-control mt-1" placeholder="fixed event_id (optional)">
    </div>
    <div class="d-flex gap-2 align-items-center mt-3">
      <button class="btn btn-success" onclick="PB.start()">Start</button>
      <button class="btn btn-outline-secondary" onclick="PB.stop()">Stop</button>
      <span class="ms-3">Status: <span id="pb-status" class="badge text-bg-secondary">stopped</span></span>
    </div>
    <div class="mt-3 d-flex gap-4 flex-wrap">
      <div><div class="small text-muted">Sent</div><div class="fs-4" id="pb-sent">0</div></div>
      <div><div class="small text-muted">Errors</div><div class="fs-4" id="pb-err">0</div></div>
    </div>
    <hr>
    <p class="small text-muted">
      Keep QPS 1–5 for steady tests; 10 for short bursts. Use <b>uuid</b> event_id if you’ll pair with CAPI for dedupe testing.
    </p>
  </div>
</div>
<script>
const PB = (function(){
  let running=false, h=null, sent=0, err=0, bucket=[];
  const $ = id => document.getElementById(id);
  function badge(){ $('pb-status').className = 'badge text-bg-'+(running?'success':'secondary'); $('pb-status').textContent = running?'running':'stopped' }
  function tokenBucketOk(cap){
    const now=performance.now()/1000;
    while(bucket.length && now-bucket[0]>1.0) bucket.shift();
    if (cap<=0) return true;
    if (bucket.length<cap){ bucket.push(now); return true }
    return false;
  }
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m? m.pop() : null;
  }
  function ensureFbp(){
    let fbp = getCookie('_fbp');
    if(!fbp){
      const ts = Math.floor(Date.now()/1000);
      const rand = Math.floor(Math.random()*1e10);
      fbp = `fb.1.${ts}.${rand}`;
      document.cookie = `_fbp=${fbp}; path=/; SameSite=Lax`;
    }
    return fbp;
  }
  function makeUuid(){ return URL.createObjectURL(new Blob()).split('/').pop(); }
  function eventId(){
    const m = document.querySelector('input[name="pb-eid-mode"]:checked').value;
    if(m==='uuid') return makeUuid();
    if(m==='fixed') return ($('pb-eid-fixed-val').value.trim()||'fixed-event-id');
    return null;
  }
  function buildUrl(){
    const id = $('pb-pixel').value.trim();
    const ev = $('pb-event').value.trim() || 'PageView';
    const fbp = ensureFbp();
    const dl = encodeURIComponent(window.location.href);
    const rl = encodeURIComponent(document.referrer||'');
    const ts = Math.floor(Date.now()/1000);
    const r = Math.random().toString(36).slice(2);
    let url = `https://www.facebook.com/tr?id=${encodeURIComponent(id)}&ev=${encodeURIComponent(ev)}&dl=${dl}&rl=${rl}&ts=${ts}&fbp=${encodeURIComponent(fbp)}&r=${r}`;
    if(ev==='Purchase'){
      const val = parseFloat($('pb-val').value||'0')||0;
      const cur = $('pb-cur').value.trim()||'USD';
      url += `&cd[value]=${encodeURIComponent(val)}&cd[currency]=${encodeURIComponent(cur)}`;
    }
    const eid = eventId(); if(eid) url += `&eid=${encodeURIComponent(eid)}`;
    return url;
  }
  function tick(){
    if(!running) return;
    try{
      const qps = Math.max(1, Math.min(10, parseInt($('pb-qps').value||'1',10)));
      const attempts = Math.max(1, Math.round(qps / 5)); // 200ms tick
      for(let i=0;i<attempts;i++){
        if(!running) break;
        if(!tokenBucketOk(qps)) break;
        const img = new Image();
        img.onload = ()=>{ sent++; $('pb-sent').textContent=sent; };
        img.onerror = ()=>{ err++; $('pb-err').textContent=err; };
        img.src = buildUrl() + `&cb=${Math.random().toString(36).slice(2)}`;
      }
    }catch(e){ /* ignore */ }
  }
  return {
    start(){
      if(running) return;
      running=true; badge();
      if(h) clearInterval(h); bucket=[];
      h = setInterval(tick, 200);
      tick();
      // auto stop by duration if set
      const dur = Math.max(1, parseInt(document.getElementById('pb-dur').value||'60',10));
      setTimeout(()=>{ if(running) PB.stop(); }, dur*1000);
    },
    stop(){
      running=false; badge(); if(h){ clearInterval(h); h=null; }
    }
  }
})();
</script>
</body></html>
