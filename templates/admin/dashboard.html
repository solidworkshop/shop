
{% extends 'admin/layout.html' %}
{% block body %}
<div class="container py-4">
  <div class="row g-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Automation</strong>
          <span id="automation-status" class="badge text-bg-{{ 'success' if running else 'secondary' }}">{{ 'running' if running else 'stopped' }}</span>
        </div>
        <div class="card-body d-flex gap-2">
          <button class="btn btn-success btn-sm" onclick="startIntervals()">Start</button>
          <button class="btn btn-outline-secondary btn-sm" onclick="stopIntervals()">Stop</button>
          <a class="btn btn-link btn-sm" href="/admin/ping" target="_blank">Ping</a>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
async function apiPost(url, body=null){
  const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):null});
  const txt = await res.text();
  try { return {ok: res.ok, status: res.status, json: JSON.parse(txt)}; } catch { return {ok: res.ok, status: res.status, text: txt}; }
}
async function startIntervals(){
  const r = await apiPost('/admin/automation/start');
  const el = document.getElementById('automation-status');
  if(el){ el.className = 'badge text-bg-' + ((r.ok && r.json && r.json.ok)?'success':'danger'); el.textContent = (r.ok && r.json && r.json.ok)?'running':'error'; }
}
async function stopIntervals(){
  const r = await apiPost('/admin/automation/stop');
  const el = document.getElementById('automation-status');
  if(el){ el.className = 'badge text-bg-' + ((r.ok && r.json && r.json.ok)?'secondary':'danger'); el.textContent = (r.ok && r.json && r.json.ok)?'stopped':'error'; }
}
async function pollAutomation(){
  try{
    const res = await fetch('/admin/automation/status');
    const data = await res.json();
    const el = document.getElementById('automation-status');
    if(el){ el.className = 'badge text-bg-' + (data.running?'success':'secondary'); el.textContent = data.running?'running':'stopped'; }
  }catch(e){}
}
setInterval(pollAutomation, 3000);
</script>
{% endblock %}
