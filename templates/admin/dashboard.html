
{% extends 'admin/layout.html' %}
{% block body %}
<div class="container py-4" style="max-width:1000px">
  <!-- Automation -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Automation</strong>
      <span id="automation-status" class="badge text-bg-{{ 'success' if running else 'secondary' }}">{{ 'running' if running else 'stopped' }}</span>
    </div>
    <div class="card-body d-flex flex-wrap gap-2 align-items-center">
      <button class="btn btn-success btn-sm" onclick="startIntervals()">Start</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="stopIntervals()">Stop</button>
      <div class="input-group input-group-sm kv-w">
        <span class="input-group-text">Interval (s)</span>
        <input type="number" min="1" class="form-control" value="{{ cfg.automation_interval or 5 }}" onblur="saveKV('automation_interval', this.value)">
      </div>
      <div class="input-group input-group-sm kv-w">
        <span class="input-group-text">Concurrency</span>
        <input type="number" min="1" max="10" class="form-control" value="{{ cfg.automation_concurrency or 2 }}" onblur="saveKV('automation_concurrency', this.value)">
      </div>
      <div class="input-group input-group-sm kv-w">
        <span class="input-group-text">Pixel QPS</span>
        <input type="number" min="0" class="form-control" value="{{ cfg.pixel_qps or 5 }}" onblur="saveKV('pixel_qps', this.value)">
      </div>
      <div class="input-group input-group-sm kv-w">
        <span class="input-group-text">CAPI QPS</span>
        <input type="number" min="0" class="form-control" value="{{ cfg.capi_qps or 5 }}" onblur="saveKV('capi_qps', this.value)">
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="dry-run" {% if cfg.dry_run=='1' %}checked{% endif %} onchange="saveKV('dry_run', this.checked?1:0)">
        <label class="form-check-label" for="dry-run">Self-test Dry Run</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="en_px" {% if cfg.enable_pixel!='0' %}checked{% endif %} onchange="saveKV('enable_pixel', this.checked?1:0)">
        <label class="form-check-label" for="en_px">Enable Pixel</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="en_ca" {% if cfg.enable_capi!='0' %}checked{% endif %} onchange="saveKV('enable_capi', this.checked?1:0)">
        <label class="form-check-label" for="en_ca">Enable CAPI</label>
      </div>
    </div>
  </div>

  <!-- Events & toggles -->
  <div class="card mb-3">
    <div class="card-header"><strong>Event Toggles</strong></div>
    <div class="card-body row row-cols-2 row-cols-md-3 g-1">
      {% for ev in standard_events %}
      <div class="col">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="ev_{{ev}}" {% if ev_toggles[ev] %}checked{% endif %} onchange="saveKV('on_{{ev}}', this.checked?1:0)">
          <label class="form-check-label" for="ev_{{ev}}">{{ ev }}</label>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Counters & Recent -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Counters</strong>
      <a class="btn btn-link btn-sm" href="/admin/inspector">Open Inspector</a>
    </div>
    <div class="card-body">
      <div class="d-flex gap-4 flex-wrap mb-3">
        <div><div class="small text-muted">Pixel</div><div id="cnt-pixel" class="fs-4">{{ counters.pixel }}</div></div>
        <div><div class="small text-muted">CAPI</div><div id="cnt-capi" class="fs-4">{{ counters.capi }}</div></div>
        <div><div class="small text-muted">Deduped</div><div id="cnt-deduped" class="fs-4">{{ counters.deduped }}</div></div>
        <div><div class="small text-muted">Margin (events)</div><div id="cnt-margin_events" class="fs-4">{{ counters.margin_events }}</div></div>
        <div><div class="small text-muted">PLTV (events)</div><div id="cnt-pltv_events" class="fs-4">{{ counters.pltv_events }}</div></div>
      </div>
      <div class="small text-muted">Recent events</div>
      <ul id="recent-ul" class="list-group list-group-flush border rounded"></ul>
    </div>
  </div>

  <!-- Chaos -->
  <div class="card mb-3">
    <div class="card-header"><strong>Chaos</strong></div>
    <div class="card-body d-flex flex-wrap gap-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" onchange="saveKV('chaos_drop', this.checked?1:0)"> <label class="form-check-label">Drop</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" onchange="saveKV('chaos_omit_ud', this.checked?1:0)"> <label class="form-check-label">Omit user_data</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" onchange="saveKV('chaos_malformed', this.checked?1:0)"> <label class="form-check-label">Malformed</label>
      </div>
    </div>
  </div>

  <!-- Manual Test -->
  <div class="card mb-4">
    <div class="card-header"><strong>Manual Test Send</strong></div>
    <div class="card-body">
      <div class="input-group">
        <span class="input-group-text">Manual JSON</span>
        <input id="manual-json" class="form-control" placeholder='{"event_name":"Purchase","custom_data":{"value":9.99,"currency":"USD"}}'>
        <button class="btn btn-primary" onclick="manualSend()">Send</button>
      </div>
      <div class="form-text">Toggle <b>Self-test Dry Run</b> in Automation to avoid hitting Graph.</div>
      <div class="small text-muted mt-1" id="manual-res"></div>
    </div>
  </div>

  <!-- Health -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Health & Pixel Check</strong>
      <button class="btn btn-outline-primary btn-sm" onclick="runPixelCheck()">Run Pixel Check</button>
    </div>
    <div class="card-body">
      <code id="pixel-check-res" class="small text-muted"></code>
    </div>
  </div>
</div>
<script>setTimeout(()=>{ refreshAll(); }, 250);</script>
{% endblock %}
